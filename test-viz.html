<!DOCTYPE html>
<html>
<head>
    <title>Canopy Visualization Test</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        #status { 
            padding: 10px; 
            margin: 10px 0; 
            background: #252526;
            border-radius: 4px;
        }
        #graph { 
            width: 800px; 
            height: 600px; 
            border: 1px solid #3e3e42;
            background: #1e1e1e;
        }
        .node rect {
            fill: #2d2d30;
            stroke: #007acc;
            stroke-width: 2;
        }
        .node text {
            fill: #d4d4d4;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Canopy Visualization Test</h1>
    <div id="status">Connecting to WebSocket...</div>
    <svg id="graph"></svg>
    
    <script>
        const status = document.getElementById('status');
        const svg = d3.select('#graph');
        
        // Test WebSocket connection
        const ws = new WebSocket('ws://127.0.0.1:7890/ws');
        
        ws.onopen = () => {
            status.innerHTML = '<span style="color: #89d185;">WebSocket connected!</span>';
        };
        
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                status.innerHTML += '<br>Received: ' + data.type;
                
                if (data.type === 'full_graph') {
                    renderGraph(data.graph);
                }
            } catch (e) {
                status.innerHTML += '<br><span style="color: #f48771;">Error: ' + e.message + '</span>';
            }
        };
        
        ws.onerror = (error) => {
            status.innerHTML += '<br><span style="color: #f48771;">WebSocket error</span>';
        };
        
        ws.onclose = () => {
            status.innerHTML += '<br><span style="color: #f48771;">WebSocket closed</span>';
        };
        
        function renderGraph(graphData) {
            status.innerHTML += '<br>Rendering graph with ' + graphData.nodes.length + ' nodes and ' + graphData.edges.length + ' edges';
            
            // Simple rendering test
            const nodes = graphData.nodes.slice(0, 10); // Just show first 10 nodes
            
            const nodeElements = svg.selectAll('.node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', (d, i) => `translate(${50 + (i % 5) * 150}, ${50 + Math.floor(i / 5) * 100})`);
            
            nodeElements.append('rect')
                .attr('width', 120)
                .attr('height', 40)
                .attr('x', -60)
                .attr('y', -20)
                .attr('rx', 4);
            
            nodeElements.append('text')
                .text(d => d.name || d.id)
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em');
                
            status.innerHTML += '<br><span style="color: #89d185;">Graph rendered successfully!</span>';
        }
    </script>
</body>
</html>